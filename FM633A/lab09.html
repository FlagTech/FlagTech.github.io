<title>
    LAB09 æ™‚å…‰ LINE è† å›Š
</title>
<style>
    html,
    body {
        height: 100%;
        padding: 0;
        margin: 0;
        background-color: rgb(203, 236, 255);
        background: linear-gradient(135deg, rgb(54, 0, 104) 0%, rgb(121, 63, 155) 25%, rgb(102, 0, 97) 53%, rgb(105, 2, 50) 100%);
    }

    h1 {
        text-align: center;
        color: cornflowerblue;
        padding-top: 5px;
        -webkit-text-fill-color: rgb(39, 194, 0);
        /* Will override color (regardless of order) */
        -webkit-text-stroke-width: 1px;
        -webkit-text-stroke-color: black;
    }

    #startBtn {
        background-color: rgb(128, 128, 128);
        width: 40%;
        height: 10vh;
        border-radius: 10px;
        color: rgb(65, 65, 65);
        font-size: xx-large;
        margin-top: 10px;
        /* border: 5px solid rgb(128, 128, 128); */
        border: outset;
        /* padding-top: 50px; */
        box-shadow: inset 0 -8px 0 0 rgba(0, 0, 0, .2),
            1px 1px 0 0 #0e4158,
            2px 2px 0 0 #0e4158,
            3px 3px 0 0 #0e4158,
            4px 4px 0 0 #0e4158,
            5px 5px 0 0 #0e4158;
    }

    #sendBtn {
        background-color: rgb(129, 69, 0);
        width: 40%;
        height: 10vh;
        border-radius: 10px;
        color: rgb(0, 0, 0);
        font-size: xx-large;
        margin: auto;
        margin-top: 10px;
        border: outset;
        border-color: black;
        display: none;
        /* padding-top: 50px; */
        box-shadow: inset 0 -8px 0 0 rgba(0, 0, 0, .2),
            1px 1px 0 0 #532500c4,
            2px 2px 0 0 #532600c4,
            3px 3px 0 0 #532600c4,
            4px 4px 0 0 #532600c4,
            5px 5px 0 0 #532600c4;
        -webkit-text-stroke-width: 0.5px;
        -webkit-text-stroke-color: rgb(109, 49, 0);
    }

    .inputtext {
        width: 100%;
        padding: 12px 20px;
        margin: 8px 0;
        display: inline-block;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: large;
        height: fit-content;
    }

    .msgbox {
        text-align: center;
        font-size: x-large;
        border-radius: 15px;
        background-color: cadetblue;
        opacity: 75%;
        border: 5px solid rgb(41, 41, 41);
        width: 80%;
        margin: auto;
        padding: 20px;
        padding-top: 0mm;
        /* display: none; */
        box-shadow: inset 0 -8px 0 0 rgba(0, 0, 0, .2),
            1px 1px 0 0 #0e4158,
            2px 2px 0 0 #0e4158,
            3px 3px 0 0 #0e4158,
            4px 4px 0 0 #0e4158,
            5px 5px 0 0 #0e4158,
            6px 6px 0 0 #0e4158,
            7px 7px 0 0 #0e4158,
            8px 8px 0 0 #0e4158,
            9px 9px 0 0 #0e4158,
            10px 10px 0 0 #0e4158,
            11px 11px 0 0 #0e4158,
            12px 12px 0 0 #0e4158;
    }

    .left {
        text-align: left;
        float: left;
        /* padding-left: 3%; */
        font-size: large;
    }

    .right {
        height: 100vh;
        width: 20%;
        background-color: rgb(248, 85, 85);
        float: right;
    }

    .dot {
        height: 25px;
        width: 25px;
        background-color: #bbb;
        border-radius: 50%;
        display: inline-block;

        position: absolute;

        top: 5%;
        left: 5%;
        /* transform: translate(-50%, -50%);
        -ms-transform: translate(-50%, -50%); */
        color: black;
        font-size: 16px;
        /* padding: 16px 30px; */
        border: none;
        /* cursor: pointer; */
        text-align: center;
        z-index: 100;
    }

    .label {
        /* vertical-align:bottom; */
        font-size: large;
        color: #80ff00;
        margin: auto;
        margin-top: 10px;
        text-align: center;
        /* transform: translate(-50%, -50%);
        -ms-transform: translate(-50%, -50%); */
        z-index: 99;
        position: relative;
        background: transparent;
        background-color: rgb(87, 87, 87);
        opacity: 90%;
        border-radius: 10px;
        padding: 10px;
        width: 80%;
        height: fit-content;
        display: none;

        /* visibility: hidden; */
    }

    #webcamVideo {
        z-index: 0;
        /* width: 100%; */
        /* opacity:.65; */
        /* min-height:100vh; */
        margin: auto;
        /* position:absolute; */
        min-width: 100%;
        border-radius: 10px;
        position: relative;
        /* position:fixed; */
        /* background: transparent; */
        /* border-radius: 5px; */
        /* -webkit-transform: scaleX(-1);
        -moz-transform: scaleX(-1);
        -o-transform: scaleX(-1);
        transform: scaleX(-1); */

        filter: FlipH;
        -ms-filter: "FlipH";
    }

    .cam {
        /* position: absolute; 
        right: 0; 
        bottom: 0;
        min-width: 100%; 
        min-height: 100%;
        width: auto; 
        height: auto;  */
        border-radius: 10px;
        z-index: 1;
        /* background-size: cover;
        overflow: hidden; */
    }
</style>
<!-- <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css"> -->
<!-- <link rel='stylesheet' type='text/css' href='clock.css'> -->

<body>
    <!-- <div class="left"> -->
    <h1>LAB09 æ™‚å…‰ LINE è† å›Š</h1>
    <div class="div-relative" style="margin: auto;width: 90%;">
        <div class="msgbox" id="msgbox">
            <p style="color: black;">
            
            <label class="left">Teachable Machine æ¨¡å‹ç¶²å€:</label>  
            <input type="text" id="modelurl" class="inputtext" name="inputtext" value=""><br>
            <!-- <input type="text" id="modelurl" class="inputtext" name="inputtext" value="https://teachablemachine.withgoogle.com/models/2YZvRiW3W/"><br>         -->
         
            <label class="left">Adafruit IO é‡‘é‘°:</label>
            <input type="text" id="activekey" class="inputtext" name="inputtext" autocomplete="on" value=""><br>
            <label class="left">Adafruit IO å¸³è™Ÿ:</label>
            <input type="text" id="username" class="inputtext" name="inputtext" autocomplete="on" value=""><br>
            <label class="left">Adafruit IO Feed:</label>
            <input type="text" id="feed" class="inputtext" name="inputtext" autocomplete="on" value="timecapsule"><br>
            
                <label class="left">è† å›Šè§£é–æ™‚é–“ï¼š</label>
                <input type="datetime-local" class="inputtext" id="deadline" name="deadline" style="font-size: xx-large;"><br>
            
            <button id="startBtn" type="button" onclick="init()" disabled>Start</button>
            </p>
        
        
        </div>

        <!-- <span id="dot1" class="dot"></span> -->

        <div id="label-container" class="label"></div>
        <br>
        <div id="webcam-container" class="cam"></div>
        <div>
            <h2 id='clock' style="text-align: center;color: cyan;">ç¾åœ¨æ™‚é–“</h2>
        </div>
        <button id="sendBtn" type="button" onclick="preding()">ğŸ”“è§£é–è† å›Š</button>
    </div>
    <!-- </div> -->
    <!-- <div class="right"></div> -->
</body>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/seedrandom.min.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script> -->
<script src="https://cdn.bootcss.com/noty/3.1.4/noty.min.js"></script>
<script type="text/javascript">
    // More API functions here:
    // https://github.com/googlecreativelab/teachablemachine-community/tree/master/libraries/image

    $(document).ready(function () {
        $('#activekey').on('input', function () {
            if ($(this).val() != '') {
                $('#startBtn').attr('disabled', false);
                $('#startBtn').css({
                    'color': 'rgb(255,255,255)',
                    'background-color': 'rgb(65,65,65)'
                })
            } else {
                $('#startBtn').attr('disabled', true);
                $('#startBtn').css({
                    'color': 'rgb(65,65,65)',
                    'background-color': 'rgb(128,128,128)'
                })
            }
        });
    });

    let model, webcam, labelContainer, maxPredictions, aio_n, aio_k, aio_f;
    var sendClicked = false;
    var timesup = false;
    var pred_result_index = 0;
    var odate;
    // Load the image model and setup the webcam
    async function init() {

        // the link to your model provided by Teachable Machine export panel
        const URL = document.getElementById("modelurl").value;
        if ($('#deadline').val() != ""){
            odate = new Date($('#deadline').val());
        }
        else{
            odate = new Date();
        }
        
        document.getElementById("msgbox").style.display = "none";
        // document.getElementById("scoreBar").style.display = "block";
        labelContainer = document.getElementById("label-container");
        labelContainer.appendChild(document.createElement("h2"));
        labelContainer.firstChild.innerHTML = "æ¨¡å‹è®€å–ä¸­...";
        console.log(odate);

        labelContainer.style.display = "block";

        //******Read AIO info.*******
        // Adafruit user name
        aio_n = document.getElementById("username").value;
        // Adafruit IO Key
        aio_k = document.getElementById("activekey").value;
        // Adafruit feed name 
        aio_f = document.getElementById("feed").value;

        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        // load the model and metadata
        // Refer to tmImage.loadFromFiles() in the API to support files from a file picker
        // or files from your local hard drive
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();


        // convenience function to setup a webcam
        const flip = true; // whether to flip the webcam
        webcam = new tmImage.Webcam(200, 200, flip); // width, height
        await webcam.setup({
            facingMode: "user"
        }); // use "user" to use front-cam on mobile phones

        // append elements to the DOM --> **before starting the webcam**
        // document.getElementById('webcam-container').appendChild(webcam.canvas); // just in case you want to use specifically the canvas
        document.getElementById('webcam-container').appendChild(webcam
            .webcam); // webcam object needs to be added in any case to make this work on iOS

        // grab video-object in any way you want and set the attributes --> **"muted" and "playsinline"**
        let wc = document.getElementsByTagName('video')[0];
        wc.setAttribute("playsinline", true); // written with "setAttribute" bc. iOS buggs otherwise :-)

        wc.muted = "true"
        wc.id = "webcamVideo";

        // only now start the webcam --> **after video-object added to DOM and attributes are set**
        webcam.play();
        window.requestAnimationFrame(loop); // update canvas by loop-function
        document.getElementById("sendBtn").style.display = "block";
        // æ›´æ”¹ è®€å–ä¸­ æ–‡å­—
        labelContainer.firstChild.innerHTML = "æº–å‚™å¥½å¾Œè«‹æŒ‰ä¸‹è§£é–æŒ‰éˆ•";
        //å¢åŠ æ”¾ label çš„ Div
        for (let i = 0; i < maxPredictions; i++) { // and class labels
            labelContainer.appendChild(document.createElement("div"));
        }
        predict();
    }

    async function loop() {
        webcam.update(); // update the webcam frame
        // await predict();
        window.requestAnimationFrame(loop);
    }

    // run the webcam image through the image model
    function preding() {
        labelContainer.firstChild.innerHTML = 'è† å›Šè§£é–ä¸­...';
        // document.getElementById("sendBtn").style.backgroundColor = "#bbb";
        // document.getElementById("sendBtn").setAttribute("disabled","true");
        
        sendClicked = true;
        predict();
    }
    async function predict() {
        // predict can take in an image, video or canvas html element
        const prediction = await model.predict(webcam.canvas);

        var pred_result = [];
        for (let i = 0; i < maxPredictions; i++) {
            const Predct_Name = prediction[i].className;
            const Predct_Probability = prediction[i].probability.toFixed(2);

            if (typeof pred_result !== 'undefined' && pred_result.length == 0) {
                pred_result = [parseFloat(Predct_Probability), Predct_Name];
            } else if (parseFloat(Predct_Probability) > pred_result[0]) {
                pred_result = [parseFloat(Predct_Probability), Predct_Name];
                pred_result_index = i;
            }

            // console.log([parseFloat(Predct_Probability), parseFloat(pred_result[0])]);

            // labelContainer.childNodes[i].innerHTML = Predct_Name + " : " + Predct_Probability;
        }
        if (sendClicked) {
            if (timesup){
                if (pred_result_index == 1){
                    labelContainer.firstChild.innerHTML = "å—¨ï¼" + pred_result[1] + "ï¼" + "æ‚¨çš„æ™‚å…‰è† å›Šå·²è§£é–, æ‰“é–‹ LINE çœ‹çœ‹å§ï¼";
                    //****POST Value****
                    $.ajax({
                            url: "https://io.adafruit.com/api/v2/" + aio_n + "/feeds/" + aio_f + "/data?X-AIO-Key=" +
                                aio_k,
                            type: "POST",
                            data: {
                                "value": 100
                            },
                        })
                        .fail(function () {
                            new Noty({
                                text: 'ç„¡æ³•ç™¼å‡ºé€šçŸ¥',
                                type: 'error'
                            }).show();
                        });
                        sendClicked = false;
                }
                else{
                    labelContainer.firstChild.innerHTML = "å¾ˆæŠ±æ­‰ï¼åªæœ‰" + prediction[1].className + "å¯ä»¥é–‹å•Ÿè† å›Š";
                }

            }
            else{
                labelContainer.firstChild.innerHTML = "è† å›Šè§£é–æ™‚é–“é‚„æ²’åˆ°ï½å†ç­‰ç­‰å–”ï¼"
            }
            pred_result_index = 0;
        }
        


    }
    var h2 = document.getElementById('clock');

// display current time by the second
// var currentTime = setInterval(function () {
//     var date = new Date();

//     var hours = (12 - (date.getHours()));
//     // var hours = date.getHours();

//     var minutes = date.getMinutes();

//     var seconds = date.getSeconds();

//     var ampm = (date.getHours()) < 12 ? 'AM' : 'PM';


//     //convert military time to standard time

//     if (hours < 0) {
//         hours = hours * -1;
//     } else if (hours == 00) {
//         hours = 12;
//     } else {
//         hours = hours;
//     }


//     h2.textContent = addZero(hours) + ":" + addZero(minutes) + ":" + addZero(seconds) + "" + ampm;

// }, 1000);
    /*functions to get hour, min, secs, 
        am or pm, add zero, set alarm time and sound, clear alarm
        */

    function addZero(time) {

        return (time < 10) ? "0" + time : time;

    }

    setInterval(function () {

        var date = new Date();

        var yyyy = date.getFullYear();

        var mm = date.getMonth();

        var dd = date.getDate();

        var hours = (12 - (date.getHours()));
        // var hours = date.getHours();

        var minutes = date.getMinutes();

        var seconds = date.getSeconds();

        var ampm = (date.getHours()) < 12 ? 'AM' : 'PM';


        //convert military time to standard time

        if (hours < 0) {
            hours = hours * -1;
        } else if (hours == 00) {
            hours = 12;
        } else {
            hours = hours;
        }

        var currentTime = h2.textContent = "ç¾åœ¨æ™‚é–“ï¼š" + yyyy + "-" + addZero(mm) + "-" + addZero(dd) + " " + ampm +addZero(hours) + ":" + addZero(minutes) + ":" + addZero(seconds) ;
       
        if (date - odate >= 0){
            timesup = true;
        }
        // console.log(date - odate);

    }, 1000);
</script>